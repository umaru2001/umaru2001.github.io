<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="web, 图片, API"><meta name="description" content="这里是海星来来的博客，虽然他是一个程序员，但是这篇博客应该会很少更新技术相关的东西，因为这太无聊了。"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="theme-color" content="#ffffff"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>图片压缩的不同姿势 | 海祇岛的珊瑚森林</title><link rel="manifest" href="/manifest.json"><link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/favicon.webp"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/awesome/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/materialize/materialize.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/aos/aos.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/animate/animate.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/css/matery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/css/my.css"><script src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/jquery/jquery.min.js"></script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="海祇岛的珊瑚森林" type="application/atom+xml"></head><body><script>// 每天切换 banner 图.  Switch banner image every day.
      const _dayOfWeek = new Date().getDay();
      if (_dayOfWeek === 1 || _dayOfWeek === 6) {
        document.body.classList.add('purple');
      } else if (_dayOfWeek >= 2 && _dayOfWeek <= 3) {
        document.body.classList.add('orange');
      } else if (_dayOfWeek == 4) {
        document.body.classList.add('blue');
      }
      _setCookie = (name, value, days) => {
        if (days) {
          var date = new Date();
          date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
          var expires = "; expires=" + date.toGMTString()
        } else var expires = "";
        document.cookie = name + "https://pengdonglaicom=" + value + expires + "; path=/"
      }

      _getCookie = (name) => {
        var nameEQ = name + "https://pengdonglaicom=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0) == ' ') c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length)
        }
        return null
      }

      window.DarkReader = {
        darkmode: _getCookie('targetDarkmode') === '1',
        changeMode: function () {
            if (this.darkmode) {
                document.body.classList.remove('black');
                const d = new Date().getDay();
                if (d === 1 || d === 6) {
                    document.body.classList.add('purple');
                } else if (d >= 2 && d <= 3) {
                    document.body.classList.add('orange');
                } else if (d == 4) {
                    document.body.classList.add('blue');
                }
                this.darkmode = false;
                _setCookie('targetDarkmode', 0, 7);
                window.changePostCalendarDarkMode && changePostCalendarDarkMode();
            } else {
                document.body.classList.remove('purple', 'orange', 'blue');
                document.body.classList.add('black');
                this.darkmode = true;
                _setCookie('targetDarkmode', 1, 7);
                window.changePostCalendarDarkMode && changePostCalendarDarkMode();
            }
        }
      }
      if (_getCookie('targetDarkmode') === '1') {
          document.body.classList.remove('purple', 'orange', 'blue');
          document.body.classList.add('black');
      }</script><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><img src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/favicon.webp" class="logo-img" alt="LOGO"> <span class="logo-span">海祇岛的珊瑚森林</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="" class="waves-effect waves-light"><i class="fas fa-folder-plus" style="zoom:.6"></i> <span>文章</span> <i class="fas fa-chevron-down" aria-hidden="true" style="zoom:.6"></i></a><ul class="sub-nav menus_item_child"><li><a href="/tags"><i class="fas fa-tags fa-fw" style="margin-top:-20px;zoom:.6"></i> <span>标签</span></a></li><li><a href="/archives"><i class="fas fa-archive fa-fw" style="margin-top:-20px;zoom:.6"></i> <span>归档</span></a></li><li><a href="/categories"><i class="fas fa-bookmark fa-fw" style="margin-top:-20px;zoom:.6"></i> <span>分类</span></a></li><li><a target="_blank" rel="noopener" href="http://docs.starfishdl.site"><i class="fas fa-file fa-fw" style="margin-top:-20px;zoom:.6"></i> <span>文档站</span></a></li></ul></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fas fa-user-circle" style="zoom:.6"></i> <span>关于</span></a></li><li class="hide-on-med-and-down nav-item"><a href="" class="waves-effect waves-light"><i class="fas fa-list" style="zoom:.6"></i> <span>多媒体</span> <i class="fas fa-chevron-down" aria-hidden="true" style="zoom:.6"></i></a><ul class="sub-nav menus_item_child"><li><a href="/musics"><i class="fas fa-music fa-fw" style="margin-top:-20px;zoom:.6"></i> <span>音乐</span></a></li><li><a target="_blank" rel="noopener" href="http://pengdonglai.com/?show_drawer=true"><i class="fas fa-address-book fa-fw" style="margin-top:-20px;zoom:.6"></i> <span>收藏链接</span></a></li><li><a href="/bangumis"><i class="fas fa-film fa-fw" style="margin-top:-20px;zoom:.6"></i> <span>追番</span></a></li></ul></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li><li><a href="javascript:DarkReader?.changeMode()" class="waves-effect waves-light"><i id="searchIcon" class="fas darkmode-icon" title="暗黑模式开关" style="zoom:.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img alt="avatar" src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/medias/avatar.webp" class="logo-img circle responsive-img"><div class="logo-name">海祇岛的珊瑚森林</div><div class="logo-desc">这里是海星来来的博客，虽然他是一个程序员，但是这篇博客应该会很少更新技术相关的东西，因为这太无聊了。</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fas fa-folder-plus"></i> 文章 <span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/tags" style="margin-left:75px"><i class="fa fas fa-tags fa-fw" style="position:absolute;left:50px"></i> <span>标签</span></a></li><li><a href="/archives" style="margin-left:75px"><i class="fa fas fa-archive fa-fw" style="position:absolute;left:50px"></i> <span>归档</span></a></li><li><a href="/categories" style="margin-left:75px"><i class="fa fas fa-bookmark fa-fw" style="position:absolute;left:50px"></i> <span>分类</span></a></li><li><a target="_blank" rel="noopener" href="http://docs.starfishdl.site" style="margin-left:75px"><i class="fa fas fa-file fa-fw" style="position:absolute;left:50px"></i> <span>文档站</span></a></li></ul></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fas fa-list"></i> 多媒体 <span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/musics" style="margin-left:75px"><i class="fa fas fa-music fa-fw" style="position:absolute;left:50px"></i> <span>音乐</span></a></li><li><a target="_blank" rel="noopener" href="http://pengdonglai.com/?show_drawer=true" style="margin-left:75px"><i class="fa fas fa-address-book fa-fw" style="position:absolute;left:50px"></i> <span>收藏链接</span></a></li><li><a href="/bangumis" style="margin-left:75px"><i class="fa fas fa-film fa-fw" style="position:absolute;left:50px"></i> <span>追番</span></a></li></ul></li><li><div class="divider"></div></li><li><a href="https://github.com/umaru2001" class="waves-effect waves-light" target="_blank"><i class="fab fa-github-square fa-fw"></i>来看看我呀~</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#000;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://github.com/umaru2001" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="来看看我呀~" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><script src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/cryptojs/crypto-js.min.js"></script><script>(function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();</script><div class="bg-cover pd-header post-cover" style="background-image:url(https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/medias/featureimages/4.webp);background-position:50% 25%"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">图片压缩的不同姿势</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{padding:35px 0 15px 17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{padding-bottom:30px;overflow:scroll;max-height:75vh}#toc-content::-webkit-scrollbar{background-color:transparent}#toc-content::-webkit-scrollbar-corner{background-color:transparent}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline;font-size:1.1rem;line-height:30px}.blue #toc-content .toc-link:hover{color:#4169e1}.purple #toc-content .toc-link:hover{color:#6a5acd}.orange #toc-content .toc-link:hover{color:#ff8c00}.black #toc-content .toc-link:hover{color:#faebd7}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .toc-list-item.is-active-li{border-left:5px solid #ccc!important;border-color:#42b983!important;visibility:visible;background-color:rgba(238,243,252,.5)}.black #toc-content .toc-list-item.is-active-li{border-color:#faebd7!important;background-color:rgb(68 68 68 / 61%)}.blue #toc-content .toc-list-item.is-active-li{border-color:#4169e1!important}.purple #toc-content .toc-list-item.is-active-li{border-color:#6a5acd!important}.orange #toc-content .toc-list-item.is-active-li{border-color:#ff8c00!important}#toc-content ol.toc-list.is-collapsible{border-left:2px solid #9fabb4;margin:0 0 0 .5em}.black #toc-content ol.toc-list.is-collapsible{border-left:2px solid #898175}#toc-content .is-active-link{color:#0f9d58}.blue #toc-content .is-active-link{color:#4169e1}.purple #toc-content .is-active-link{color:#6a5acd}.orange #toc-content .is-active-link{color:#ff8c00}.black #toc-content .is-active-link{color:#faebd7}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px;background:#404040}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/API/"><span class="chip bg-color">API</span> </a><a href="/tags/web/"><span class="chip bg-color">web</span> </a><a href="/tags/%E5%9B%BE%E7%89%87/"><span class="chip bg-color">图片</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/" class="post-category">技术总结</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp; 2024-04-27</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp; 7.7k</div></div></div><hr class="clearfix"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/prism/prism.css"><div class="card-content article-card-content"><div id="articleContent"><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>众所周知，前端有许多切图的需求，其中对于图片的优化与前端也息息相关。因此无论是前端工作，还是博客的运营，亦或是希望可以用更小的成本玩转图片，必定涉及大量图片操作需求。与图片打过一些交道了，自然而然就会产生一些心得。</p><p>而在这其中，图片压缩是优化的重要手段。LCP 同样作为用户感知明显的指标之一，而图片的加载直接影响 LCP。在众多的前端面试题中，我们会经常看到图片优化的手段，但是一些优化手段如懒加载，其实也会影响用户的体验。而图片压缩，只要使用无损压缩，那么用户的体验会更好，是典型的无副作用方案。本文将介绍我平时用的顺手，并且效率也相对较高的图片处理模式。</p><blockquote><p>本文仍然在施工中…只是个半成品，后续如果有更好用的方法，我会及时更新。</p></blockquote><h2 id="图片格式转换"><a href="#图片格式转换" class="headerlink" title="图片格式转换"></a>图片格式转换</h2><p>WebP 是一种现代图片格式，可为网络上的图片提供出色的无损和有损压缩。使用 WebP，网站站长和 Web 开发者可以创建更小、更丰富的图片，从而提高网页加载速度。</p><p>与 PNG 相比，WebP 无损图片的尺寸<a target="_blank" rel="noopener" href="https://developers.google.com/speed/webp/docs/webp_lossless_alpha_study?hl=zh-cn#results">缩小了 26%</a>。WebP 有损图片比采用等效 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Structural_similarity">SSIM</a> 质量指数的同等 JPEG 图片<a target="_blank" rel="noopener" href="https://developers.google.com/speed/webp/docs/webp_study?hl=zh-cn">小 25-34%</a>。</p><p>无损 WebP 支持透明度（也称为 Alpha 通道），但只需<a target="_blank" rel="noopener" href="https://developers.google.com/speed/webp/docs/webp_lossless_alpha_study?hl=zh-cn#results">额外增加 22% 的字节</a>。对于可以接受有损 RGB 压缩的情况，有损 WebP 也支持透明度，其文件大小通常比 PNG 小 3 倍。</p><p>动画 WebP 图片支持有损、无损和透明度，与 GIF 和 APNG 相比，此类图片可缩减大小。</p><p>如今都 2024 了，我们没有理由继续使用不再支持 <code>WebP</code> 格式的设备。事实上不支持的设备凤毛麟角。所以放心大胆的将图片转换为 <code>WebP</code> 吧！除了 Python 提供类似于 image 这样的库之外，还有一些工具可以帮助我们完成图片格式的转换。</p><p>以下为 Python 提供的能力，可谓是门槛最低的方法了：</p><ul><li>使用 cv2 库将图片从 png 格式转换为 webp 格式</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> cv2
<span class="token comment"># 读入 PNG 格式的图片</span>
img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'input.png'</span><span class="token punctuation">)</span>
<span class="token comment"># 转换为 WebP 格式的图片，并保存</span>
cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span><span class="token string">'output.webp'</span><span class="token punctuation">,</span> img<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>IMWRITE_JPEG_QUALITY<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>使用 PIL 库将图片从 webp 格式转换为 png 格式</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'input.webp'</span><span class="token punctuation">)</span>
img<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
img<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'output.png'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="集成到系统原生"><a href="#集成到系统原生" class="headerlink" title="集成到系统原生"></a>集成到系统原生</h3><p><a target="_blank" rel="noopener" href="https://developers.google.com/speed/webp/docs/precompiled?hl=zh-cn">https://developers.google.com/speed/webp/docs/precompiled?hl=zh-cn</a></p><p>考虑到 WebP 是由 Google 发起的，我们可以方便的使用 Google Developer 提供的建议。我们甚至可以将 WebP 格式转换的能力内置进入系统，像 node 一样使用。如果我们这么做了，可能第一次操作的时候需要摸索，但是一旦习惯了，以后我们可以方便的使用命令行文件进行处理。</p><p>笔者使用的是 MacOS 系统，因此会比较详细的列举 Mac 的使用方法。或许我们日后可以使用类似的方法在 Linux 上使用它。Windows 系统的话，<s>先咕了，去官网应该能看懂怎么下载。</s></p><ol><li>使用 homebrew 安装 webp。<code>brew install webp</code>. 请先确保你的 brew 可用，然后再进行安装。</li></ol><p>homebrew 链接：<a target="_blank" rel="noopener" href="https://formulae.brew.sh/formula/webp">https://formulae.brew.sh/formula/webp</a></p><p>以上过程会将整个 webp 的转换工具都安装到你的系统中，如果你的系统已经安装了 webp，那么可以使用 <code>brew info webp</code> 查看<s>实际上也就是把 homebrew 的官网文字给你输出了一遍而已</s>。</p><p>它包括了：<code>cwebp</code> <code>dwebp</code>(将图片转换为原来的格式) <code>img2webp</code> 等工具。这里我们先使用 <code>cwebp</code> 举例子，进行转换。</p><ol start="2"><li>压缩为 WebP 无损压缩，需要保证 input.png 在当前目录下。</li></ol><p>我们使用 <code>cwebp</code> 工具中的“无损”选项将 PNG 转换为 WebP 无损格式。要获得最少的输出，所使用的确切命令行如下所示：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cwebp input.png <span class="token parameter variable">-lossless</span> <span class="token parameter variable">-m</span> <span class="token number">6</span> <span class="token parameter variable">-q</span> <span class="token number">100</span> <span class="token parameter variable">-o</span> webp_lossless.webp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>压缩为 WebP 有损压缩（使用 alpha 通道）</li></ol><p>我们使用 <code>cwebp</code> 工具将 PNG 转换为 WebP 有损（带有 alpha 通道）。我们选择的 WebP 质量为 90（有损压缩），alpha 质量为 100（无损压缩）。使用的确切命令行如下所示：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cwebp input.png <span class="token parameter variable">-q</span> <span class="token number">90</span> <span class="token parameter variable">-alpha_q</span> <span class="token number">100</span> <span class="token parameter variable">-m</span> <span class="token number">6</span> <span class="token parameter variable">-o</span> webp_alpha.webp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>关于 <code>cwebp</code> 的文档，可以查看：<a target="_blank" rel="noopener" href="https://developers.google.com/speed/webp/docs/cwebp?hl=zh-cn">https://developers.google.com/speed/webp/docs/cwebp?hl=zh-cn</a></p><p>有了上述技能，我们完全可以写一个脚本，批量将图片转换为 webp 格式。例如，如需转换文件夹中的所有 jpeg 文件，请尝试执行以下操作：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">for</span> <span class="token for-or-select variable">F</span> <span class="token keyword">in</span> *.jpg<span class="token punctuation">;</span> <span class="token keyword">do</span> cwebp <span class="token variable">$F</span> <span class="token parameter variable">-o</span> <span class="token variable"><span class="token variable">`</span><span class="token function">basename</span> $<span class="token punctuation">&#123;</span>F%.jpg<span class="token punctuation">&#125;</span><span class="token variable">`</span></span>.webp<span class="token punctuation">;</span> <span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果是无损压缩，我们只需要使用 <code>-lossless</code> 参数即可，当然，为确保最大的压缩比率，这里也可以使用 <code>-q</code>。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">for</span> <span class="token for-or-select variable">F</span> <span class="token keyword">in</span> *.jpg<span class="token punctuation">;</span> <span class="token keyword">do</span> cwebp <span class="token string">"<span class="token variable">$F</span>"</span> <span class="token parameter variable">-lossless</span> <span class="token parameter variable">-q</span> <span class="token number">100</span> <span class="token parameter variable">-o</span> <span class="token string">"<span class="token variable"><span class="token variable">`</span><span class="token function">basename</span> $<span class="token punctuation">&#123;</span>F%.jpg<span class="token punctuation">&#125;</span><span class="token variable">`</span></span>.webp"</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">F</span> <span class="token keyword">in</span> *.png<span class="token punctuation">;</span> <span class="token keyword">do</span> cwebp <span class="token string">"<span class="token variable">$F</span>"</span> <span class="token parameter variable">-lossless</span> <span class="token parameter variable">-q</span> <span class="token number">100</span> <span class="token parameter variable">-o</span> <span class="token string">"<span class="token variable"><span class="token variable">`</span><span class="token function">basename</span> $<span class="token punctuation">&#123;</span>F%.png<span class="token punctuation">&#125;</span><span class="token variable">`</span></span>.webp"</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>当然，用这两种方法不会删除原有的图片，如果我们需要删除原有的图片，可以使用 <code>rm</code> 命令。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">rm</span> <span class="token parameter variable">-rf</span> *.png
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> *.jpg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>或者集成：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">for</span> <span class="token for-or-select variable">F</span> <span class="token keyword">in</span> *.jpg<span class="token punctuation">;</span> <span class="token keyword">do</span> cwebp <span class="token string">"<span class="token variable">$F</span>"</span> <span class="token parameter variable">-lossless</span> <span class="token parameter variable">-q</span> <span class="token number">100</span> <span class="token parameter variable">-o</span> <span class="token string">"<span class="token variable"><span class="token variable">`</span><span class="token function">basename</span> $<span class="token punctuation">&#123;</span>F%.jpg<span class="token punctuation">&#125;</span><span class="token variable">`</span></span>.webp"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token string">"<span class="token variable">$F</span>"</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">F</span> <span class="token keyword">in</span> *.png<span class="token punctuation">;</span> <span class="token keyword">do</span> cwebp <span class="token string">"<span class="token variable">$F</span>"</span> <span class="token parameter variable">-lossless</span> <span class="token parameter variable">-q</span> <span class="token number">100</span> <span class="token parameter variable">-o</span> <span class="token string">"<span class="token variable"><span class="token variable">`</span><span class="token function">basename</span> $<span class="token punctuation">&#123;</span>F%.png<span class="token punctuation">&#125;</span><span class="token variable">`</span></span>.webp"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token string">"<span class="token variable">$F</span>"</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>当然，这种方法的另一个好处是，我们完全可以从开源的源代码自行编译成我们需要的程序，可以参考这个链接，这里不再做说明：<a target="_blank" rel="noopener" href="https://developers.google.com/speed/webp/docs/compiling?hl=zh-cn">https://developers.google.com/speed/webp/docs/compiling?hl=zh-cn</a></p><h3 id="修图工具"><a href="#修图工具" class="headerlink" title="修图工具"></a>修图工具</h3><h4 id="PhotoShop"><a href="#PhotoShop" class="headerlink" title="PhotoShop"></a>PhotoShop</h4><p>如果 2024 年了，仍然有修图工具不支持导出 <code>WebP</code> 格式，那么你也完全没必要使用它了。</p><p>这里以 PhotoShop 为例子，大致说下如何转换：</p><ol><li>打开图像处理软件，如 PhotoShop、GIMP 等。</li><li>导入要转换的图片文件。</li><li>在软件中打开“文件”菜单，选择“另存为”。</li><li>在弹出的“另存为”对话框中，选择“<code>WebP</code>”格式作为输出格式。</li></ol><p>这里也有一位作者分享了他批量转换格式的姿势：<a target="_blank" rel="noopener" href="https://blog.zhheo.com/p/1d8e31d8.html#%E5%A4%A7%E5%8A%9F%E5%91%8A%E6%88%90">https://blog.zhheo.com/p/1d8e31d8.html#%E5%A4%A7%E5%8A%9F%E5%91%8A%E6%88%90</a></p><p>不过，如果我们只是打开 PS 然后改下图片的格式，未免太大材小用。尤其是部分性能不好的电脑，PS 启动关闭可能都需要 1 分钟以上，我开个 PS 就为了改个图片格式？更不用说很多程序员的电脑里面都没有携带 PS 这款软件。自然而然，我们会倾向于使用更轻量化的工具。</p><h4 id="ImageManager"><a href="#ImageManager" class="headerlink" title="ImageManager"></a>ImageManager</h4><p>ImageManager 是一款 VS Code 插件。相比起 PhotoShop，它具备两个优点：可以在 VS Code 内「自给自足」，并且足够轻量化。当然，它之所以能轻量化的原因是因为它明白它主要的功能都是给程序员提供的。因此，它提供的所有功能都是程序员用的比较多的，对于研发来说是比较实用的。</p><p>顺便也膜拜下原作者，这是他在稀土掘金发布的本文链接：<a target="_blank" rel="noopener" href="https://juejin.cn/post/7348004403016794147">https://juejin.cn/post/7348004403016794147</a></p><p>作者对于自己的工具，显得十分自信：</p><blockquote><p>同一张图片，TinyPNG 压缩结果为 136kb，时间大概 5s；而 image-manager 压缩效果为 92kb，不到 1s！<br>如果把上传图片、下载图片这些繁琐的操作加到一起，或许 vscode 插件的效率要高上 10 倍有余</p></blockquote><p>这个插件的主要使用方法，作者仍然定义为了「图片压缩」，所以才会去和后文提到的 TinyPNG 进行对比。不过，这个插件也可以实现批量格式转换。如图所示，Image Manager 中，我们选择了一个文件夹下的图片，然后点击「转换」。转换成 webp 后，确实减少了 68% 的体积，同时也会对图片进行压缩。</p><p>在使用的时候，MacOS 使用 <code>Shift+Command+P</code> 快捷键，打开命令面板，输入 <code>Image Manager</code> 即可进入这个页面。</p><div align="center"><img src="../../../../loading2.svg" data-original="/2024/04/27/picture-compress-api/10.webp"></div><p>不过就笔者的使用体验而言，原生转换为 webp 格式后，使用 TinyPNG 压缩的效果是比这个插件要好的，所以感觉也不能直接把结论下了，应该是和图片本身存在一定的联系，部分图片使用 TinyPNG 效果好，部分使用插件效果好。不过就易用性而言，这个插件确实是做到了极致，而且转换的速度确实也非常快。</p><h3 id="在线转换"><a href="#在线转换" class="headerlink" title="在线转换"></a>在线转换</h3><p>网站上提供在线转换的服务商一大把，这里需要选取几个放在这里展示也是很不容易的。需要说明的是我的选取标准，首先就是质量。至少转换的质量非常高，转换后需要用肉眼看不出来。在某些能选择转换质量的网站上，把质量选到最高，需要能满足这一条件。其次是必须要免费，咱不能为了这唾手可得的功能花钱啊。当然，在线服务的网络状况也是一个重要因素，如果说图片上传下载的体验不好，那么实际上再好的压缩算法，易用性也很差。其中也有部分服务在国内体验可能不太好，因为众首周知的原因。当然，这个部分具体取决于当前使用者的网络状态，我会尽力说明。</p><h4 id="To-WebP"><a href="#To-WebP" class="headerlink" title="To WebP"></a>To WebP</h4><p>ToWebp.io 是一款免费在线工具，可立即转换 WebP，无需将文件上传为标准 JPG、JPEG、PNG、AVIF、GIF 和 ICO。同时，将所有可能的图像格式转换为WebP图像格式。</p><p>这个网站应该是最纯净的将图片转换为 WebP 的网站，并且完全免费。</p><p><a target="_blank" rel="noopener" href="https://towebp.io/">https://towebp.io/</a></p><div align="center"><img src="../../../../loading2.svg" data-original="/2024/04/27/picture-compress-api/9.webp"></div><p>如图所示，它支持拖拽上传，并且支持批量转换。并且具有为数不多的可以调整一些参数的功能。例如不想要太高的转换质量，那么可以调整一下，这个在极致优化的时候感觉会很有用。除此之外，他可以将图片进行缩放，这一下子就将图片压缩的「三板斧」都集齐了。</p><p>可惜的是，它不支持 API 调用。所以仅仅适合于顺手使用下的场景。</p><h4 id="Pixelied"><a href="#Pixelied" class="headerlink" title="Pixelied"></a>Pixelied</h4><p>Pixelied 是一家提供相片编辑器的服务商，旗下有个「Free Image Converter」的图片格式转换工具，让使用者通过浏览器进行在线批次编辑，而且不用担心降低照片画质，也无需下载或安装任何应用程序，提供最快速、免费且易于使用的图片转文件功能，这项服务支持各种常见图片格式包括 PNG、JPG、WebP、SVG、GIF、AVIF 和 TIFF 等超过 100 种格式。</p><div align="center"><img src="../../../../loading2.svg" data-original="/2024/04/27/picture-compress-api/7.webp"></div><p><a target="_blank" rel="noopener" href="https://pixelied.com/convert/jpg-converter/jpg-to-webp">https://pixelied.com/convert/jpg-converter/jpg-to-webp</a></p><p>它最大的优点是：免费且无限制的转换。（后文介绍的一些在线转换服务实际上有转换限制），这让我们在转换的时候可以无负担的使用。</p><p>他们家主要靠图片编辑收钱，因此提供了一些类似于云的服务。好在免费用户也能享受到部分存储空间。据介绍，免费用户有 2GB 的存储空间，确实比较良心。因此完全可以把他家进一步使用当成简易的图片编辑器来使用。付费版的区别主要是能使用更多素材，更多空间和一些 AI 能力，这些对于写代码来说反而不是很需要。</p><p>不过他家似乎没有 API 调用，因此我们无法通过代码来实现批量转换。</p><hr><h4 id="Convertio"><a href="#Convertio" class="headerlink" title="Convertio"></a>Convertio</h4><p>Convertio 是一个线上文件转换工具，它允许用户将文件从一种格式转换为另一种格式。它支持大多数常见的档案格式，包括图像、文件、音讯、影片、电子表格和更多。Convertio 还提供一些额外的功能，例如将 PDF 转换为可编辑的档案格式，或者将多个文件合并为一个单一的文件。</p><div align="center"><img src="../../../../loading2.svg" data-original="/2024/04/27/picture-compress-api/4.jpeg"></div><p><a target="_blank" rel="noopener" href="https://convertio.co/zh/jpg-%60WebP%60/">https://convertio.co/zh/jpg-WebP/</a></p><p>进去之后，我想它友好的页面设计会让您知道怎么操作的，这里就不详细展开了。</p><p>当然，它仍然有一些缺点，并且可能在部分人看来实际上没办法接受。首先是国内访问速度可能较慢，并且在特定条件下，下载的速度极慢。其次，它的免费计划限制较多，文件最大只能 100MB，在 24h 内只能转换 10 个文件，并且最多并行 2 个文件。</p><p>它支持 API 调用的方式，这块单独写在后面。</p><h4 id="CloudConvert"><a href="#CloudConvert" class="headerlink" title="CloudConvert"></a>CloudConvert</h4><p><a target="_blank" rel="noopener" href="https://cloudconvert.com/">https://cloudconvert.com/</a></p><p>CloudConvert 最引以为豪的就是它支持 218 种文件格式的转换，当然也可以随意转换图片格式。在它的网站上，你能看到它「Convert Anything to Anything」的标语。事实上，CloudConvert 不但支持转换同类别的文件格式（比如将 JPG 转换为 PNG），它甚至可以跨类别转换，比如将 DOCX 文档转换成 PNG。</p><div align="center"><img src="../../../../loading2.svg" data-original="/2024/04/27/picture-compress-api/8.webp"></div><p>不过它的免费额度也有限制，每天最多转换 25 个文件，和上面的那家如出一辙。</p><p>它同样支持 API 调用方式。</p><h4 id="改图宝"><a href="#改图宝" class="headerlink" title="改图宝"></a>改图宝</h4><p>改图宝是我比较用的顺手的在线工具，主要是它特别轻量化，并且也会对图片进行一些损害不高的压缩操作。至少我个人用着没啥问题，也没有遇到过收费的情况。</p><div align="center"><img src="../../../../loading2.svg" data-original="/2024/04/27/picture-compress-api/5.jpeg"></div><p><a target="_blank" rel="noopener" href="https://www.gaitubao.com/jpg-gif-png">https://www.gaitubao.com/jpg-gif-png</a></p><p>它的页面也十分友好，进去之后很容易找到图片格式转换的地方。</p><h3 id="比-WebP-更优秀的格式"><a href="#比-WebP-更优秀的格式" class="headerlink" title="比 WebP 更优秀的格式"></a>比 WebP 更优秀的格式</h3><p>当然，比 <code>WebP</code> 格式更好的图片，例如 <code>avif</code>，<code>heic</code> 等格式，目前还不支持多数浏览器的解析，贸然使用可能会导致图片无法正常显示。这种时候我们需要使用图片降级渲染策略。</p><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/AVIF">AVIF 的维基百科，想仔细研究的去这里！</a></p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>picture</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>img/photo.avif<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image/avif<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> // 如果浏览器支持使用
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>img/photo.webp<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image/webp<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>img/photo.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Description of Photo<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> // 浏览器不支持
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>picture</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当然，我们也可以使用 JS 方法来进行判断：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// npm install avif.js</span>
<span class="token comment">// 下面代码放到reg.js中，然后把avif-sw.js放在web服务器根目录</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"avif.js"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"/avif-sw.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token comment">&lt;!-- 注册worker --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>reg.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token comment">&lt;!-- 使用IMG标签嵌入AVIF图像 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image.avif<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token comment">&lt;!-- 或者通过CSS属性 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>image2.avif<span class="token punctuation">)</span></span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如上图，我们甚至可以依赖 service worker 的请求拦截特性，当页面发出 <code>fetch</code> 操作时，它可以将请求拦截住，然后给出自己的响应，这样就能在请求完 <code>avif</code> 格式的图片以后，在 service worker 当中调用解码器，将图片转码。同时，因为是运行在 service worker 线程当中，解码操作并不会阻塞 UI 线程。</p><p>另外，由于 <code>avif</code> 是基于 AV1 视频编码的，Chrome 等浏览器在很早之前的版本就内置了 AV1 的解码器，但是直到最近才支持 <code>avif</code> 的解析。</p><p>所以实际上在内置了原生解码器的浏览器版本里面，我们就不需要使用这个 polyfill 实现的 JS 版本解码器了，可以直接使用效率更高的原生解码器。</p><p>当你还在犹豫不决时，<a target="_blank" rel="noopener" href="https://www.bilibili.com/">bilibili</a>已经在他们的网站上使用了上了 avif 格式~ 你可以点进去它们的一篇专栏，然后用最新版本的 Chrome 去查看，看看是不是已经使用了 <code>avif</code> 格式的图片了。</p><div align="center"><img alt="b站现在越来越露了，233" src="../../../../loading2.svg" data-original="/2024/04/27/picture-compress-api/3.png"></div><h3 id="使用-API-进行转换"><a href="#使用-API-进行转换" class="headerlink" title="使用 API 进行转换"></a>使用 API 进行转换</h3><h4 id="Convertio-1"><a href="#Convertio-1" class="headerlink" title="Convertio"></a>Convertio</h4><p><a target="_blank" rel="noopener" href="https://developers.convertio.co/zh/">https://developers.convertio.co/zh/</a></p><p>首先需要注册获得一个 API_KEY。这个过程是免费的。</p><p>这是 API 文档：<a target="_blank" rel="noopener" href="https://developers.convertio.co/zh/api/docs/">https://developers.convertio.co/zh/api/docs/</a>，官方给出了一些参数：</p><table class="files-table api-params-table"><thead><tr><td style="width:170px">Field</td><td style="width:80px"></td><td style="width:80px">Type</td><td>Description</td></tr></thead><tbody><tr class="user-file-row"><td class="param-name">apikey</td><td></td><td>String</td><td style="word-break:break-word">Your API Key</td></tr><tr class="user-file-row"><td class="param-name">input</td><td></td><td>String</td><td style="word-break:break-word">Method of providing the input file.<br>Default Value:url<br>Allowed Values: url,raw,base64,upload</td></tr><tr class="user-file-row"><td class="param-name">file</td><td></td><td>String</td><td style="word-break:break-word">URL of the input file (if input=url), or file content (if input = raw/base64)</td></tr><tr class="user-file-row"><td class="param-name">filename</td><td><span class="param-opt">optional</span></td><td>String</td><td style="word-break:break-word">Input filename including extension (file.ext). Required if input = raw/base64</td></tr><tr class="user-file-row"><td class="param-name">outputformat</td><td></td><td>String</td><td style="word-break:break-word">Output format, to which the file should be converted to.</td></tr><tr class="user-file-row"><td class="param-name">options</td><td><span class="param-opt">optional</span></td><td>Object</td><td style="word-break:break-word">Conversion options. Now used to define callback URL, enable OCR and setting up its options. <b>You may find available OCR conversion options <a href="#options" style="color:#e41000">here</a> and callback example <a href="#options_callback" style="color:#e41000">here</a>.</b></td></tr></tbody></table><p>不过也像上面所说，它拥有一个免费计划，因此 API 的调用并不是无限的，好在它的限制措施也不多，只有一条：每 24h 转换 25 个文件，其它的限制也没有了，不会像有些产品，指定一堆复杂的政策骗钱。不过具体的我还没试用过，所以暂时没有 demo，平时一般都是线上服务解决问题也够了。</p><p>另外，这家的 API 服务似乎没有一些常用语言的 SDK，这可能会对开发者带来一些麻烦。（只有 PHP 的，所以 PHP 是不是世界上最好的语言呢 233）</p><p><s>不得不说，换个账号大法确实好用，希望这些网站的管理者没有看到我说的这句话。</s></p><h4 id="CloudConvert-1"><a href="#CloudConvert-1" class="headerlink" title="CloudConvert"></a>CloudConvert</h4><p><a target="_blank" rel="noopener" href="https://cloudconvert.com/pricing">https://cloudconvert.com/pricing</a></p><p>它也同样需要注册来免费获取一个 key。相比于 Convertio，它的好处是支持了各种语言的 SDK，在开发的时候更加得心应手。不过他的免费额度也只有每天 25 个文件。</p><p>以 node 为例子，它的 SDK 在 Github 给出了比较详细的 demo：<a target="_blank" rel="noopener" href="https://github.com/cloudconvert/cloudconvert-node">https://github.com/cloudconvert/cloudconvert-node</a></p><p>它的调用相比于其他的 API 来说，心智相对复杂一些。这可能是为了兼容多种文件的转换格式，因此它提供了 <code>job</code> 的概念。比如说下图就是创建了一种「工作」，其中包括了上传，转换，导出 3 个步骤。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// npm install cloudconvert --save</span>
<span class="token keyword">const</span> CloudConvert <span class="token operator">=</span>  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cloudconvert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cloudConvert <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CloudConvert</span><span class="token punctuation">(</span><span class="token string">'api_key'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> importUrl <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'my-file.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> outputName <span class="token operator">=</span> <span class="token string">'output-file'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> job <span class="token operator">=</span> <span class="token keyword">await</span> cloudConvert<span class="token punctuation">.</span>jobs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">tasks</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string-property property">'import-my-file'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">operation</span><span class="token operator">:</span> <span class="token string">'import/url'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">url</span><span class="token operator">:</span> importUrl
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token string-property property">'convert-my-file'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">operation</span><span class="token operator">:</span> <span class="token string">'convert'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">input</span><span class="token operator">:</span> <span class="token string">'import-my-file'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">output_format</span><span class="token operator">:</span> <span class="token string">'webp'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">some_other_option</span><span class="token operator">:</span> <span class="token string">'value'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token string-property property">'export-my-file'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">operation</span><span class="token operator">:</span> <span class="token string">'export/url'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">input</span><span class="token operator">:</span> outputName
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>CloudConvert 给每个使用了 <code>export/url</code> 的任务都会返回一个公共的，能在互联网访问的 url，我们就可以通过这个 url 来获取到转换后的文件。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">job <span class="token operator">=</span> <span class="token keyword">await</span> cloudConvert<span class="token punctuation">.</span>jobs<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Wait for job completion</span>

<span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cloudConvert<span class="token punctuation">.</span>jobs<span class="token punctuation">.</span><span class="token function">getExportUrls</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> writeStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'./out/'</span> <span class="token operator">+</span> file<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>

https<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    response<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writeStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    writeStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>
    writeStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个 SDK 还提供了沙盒环境，使得用户在测试 API 的时候不至于使用掉免费额度。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Pass `true` to the constructor</span>
<span class="token keyword">const</span> cloudConvert <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CloudConvert</span><span class="token punctuation">(</span><span class="token string">'api_key'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>总体使用下来，API 还是最推荐这款，虽然说免费额度一致，相比于 Convertio 使用友好，也可以避免在测试的时候丢失配额。速度也总体上比 Convertio 来的更快。</p><h2 id="图片压缩"><a href="#图片压缩" class="headerlink" title="图片压缩"></a>图片压缩</h2><p>除了格式转换之外，我们还需要考虑图片压缩的问题。一般来说，图片压缩在绝大多数情况下可以取得非常好的效果。毕竟一般图片的生产方没有压缩的意识。</p><p>如果说格式的转换可能有比较固定的范式，那么图片压缩可以说是十分考验压缩算法的水平了。不同的压缩算法，在压缩率、压缩速度、压缩质量上都有着不同的表现。市面上能提供十分有竞争力的压缩能力的厂商属实不多，愿意免费的更是少之又少。除开压缩算法，如果我们正好有让图片大小变小的需求，那么图片的大小优化也肯定会很可观。比如说网站的大图没有必要使用 8k 的大图做展示，4k 就够了。如果不是刻意的保存需求，那么我们往往能创造一个改变图片大小的环境。不过图片大小也是一定会损害图片质量的。</p><p>在这个过程中，我们自然是希望图片的质量不能损失太多。毕竟很多图片一旦失去了高清晰度，就会让显示效果大打折扣。</p><h3 id="系统自带"><a href="#系统自带" class="headerlink" title="系统自带"></a>系统自带</h3><p>MacOS 系统自带图片的压缩功能。Apple 的官方说明中提及了这一点：</p><p><a target="_blank" rel="noopener" href="https://support.apple.com/zh-cn/guide/preview/prvw2015/mac">https://support.apple.com/zh-cn/guide/preview/prvw2015/mac</a></p><ol><li>在 Mac 上的“预览” App 中，打开想要更改的文件。</li><li>选取“工具” &gt; “调整大小”，然后选择“重新采样图像”。</li><li>在“分辨率”栏中输入一个较小的值。</li><li>新的大小显示在底部。</li></ol><blockquote><p>【提示】若要同时减小多个图像的文件大小，请在同一个窗口中显示这些图像，并在窗口的边栏中选择它们，然后选取“工具” &gt; “调整大小”。</p></blockquote><p>首先 Apple 的能力确实还是值得信赖的，压缩图片很快。并且在这个过程中，可以选择一些常见的图片大小，系统能力集成，也让这个过程执行的非常丝滑方便。但是缺点也很明显：那就是能选择的尺寸太少了，且最高只支持到 <code>1280*720</code>. 在当前场景下，它确实用处只会越来越小。</p><p>在这个过程中，甚至还能顺带转换下图片的格式，可惜不支持 <code>WebP</code>。如果转换为 <code>png</code> 格式，有的时候甚至图片还会变大…</p><h3 id="imagemin"><a href="#imagemin" class="headerlink" title="imagemin"></a>imagemin</h3><p>作为前端开发，imagemin 自然是我们再熟悉不过的产品之一了。它的最大优势是我们可以集成在 CI&#x2F;CD 环境中。每当我们进行打包的时候，我们可以在打包的过程中直接使用 imagemin 来进行图片压缩。</p><p>Imagemin 是围绕「插件」构建的。插件是用于压缩特定图片格式的 npm 软件包（例如，<code>mozjpeg</code> 会压缩 JPEG）。选择插件时，最重要的考虑因素是它是「有损」还是「无损」。在无损压缩中，不会丢失任何数据。有损压缩会减小文件大小，但代价是可能会降低图片质量。如果插件未提及它是「有损」还是「无损」，您可以通过其 API 来判断：如果您可以指定输出的图片质量，则它是「有损」的。</p><table><thead><tr><th>图片格式</th><th>有损插件</th><th>无损插件</th></tr></thead><tbody><tr><td>JPEG</td><td><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/imagemin-mozjpeg">imagemin-mozjpeg</a></td><td><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/imagemin-jpegtran">imagemin-jpegtran</a></td></tr><tr><td>PNG</td><td><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/imagemin-pngquant">imagemin-pngquant</a></td><td><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/imagemin-optipng">imagemin-optipng</a></td></tr><tr><td>GIF</td><td><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/imagemin-giflossy">imagemin-giflossy</a></td><td><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/imagemin-gifsicle">imagemin-gifsicle</a></td></tr><tr><td>SVG</td><td><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/imagemin-svgo">imagemin-svgo</a></td><td></td></tr><tr><td>WebP</td><td><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/imagemin-webp">imagemin-webp</a></td><td><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/imagemin-webp">imagemin-webp</a></td></tr></tbody></table><p>在通过跟打包工具集成 imagemin 之后，我们就可以在打包的过程中，使用 imagemin 来进行图片压缩。这里使用 Webpack 为例子：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> ImageminPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'imagemin-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
<span class="token keyword">const</span> CopyWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'copy-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">'./index.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">CopyWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
        <span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token string">'img/**/**'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">to</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">ImageminPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">pngquant</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">quality</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此代码会告知 Imagemin 使用 Pngquant 插件压缩 PNG。quality 字段使用 min 和 max 值范围来确定压缩级别 - 0 是最低压缩级别，1 是最高压缩级别。如需强制所有图片以 50% 质量压缩，请将 0.5 同时作为最小值和最大值传递。</p><p>假设我们还需要压缩 jpg 文件，那么我们需要添加如下配置：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> imageminMozjpeg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'imagemin-mozjpeg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">ImageminPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">pngquant</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">quality</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 已有配置，无需新增</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">imageminMozjpeg</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">quality</span><span class="token operator">:</span> <span class="token number">50</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以说，每种插件的具体用法都不一样，具体得您自己去查阅对应插件的文档。然后我们根据项目的需要，按需进行配置。比如你的项目如果确实只是用了 <code>png</code> 和 <code>jpg</code> 两种图片格式，那么你只需要配置 <code>pngquant</code> 和 <code>mozjpeg</code> 即可。</p><p>我们甚至还可以将 Imagemin 本身用作 Node 脚本。以下代码使用 <code>imagemin-mozjpeg</code> 插件将 JPEG 文件的质量压缩为 50（0 表示最差；100 表示最佳）：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> imagemin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'imagemin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> imageminMozjpeg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'imagemin-mozjpeg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">imagemin</span><span class="token punctuation">(</span>
      <span class="token punctuation">[</span><span class="token string">'source_dir/*.jpg'</span><span class="token punctuation">,</span> <span class="token string">'another_dir/*.jpg'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">destination</span><span class="token operator">:</span> <span class="token string">'destination_dir'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">imageminMozjpeg</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">quality</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="TinyPNG"><a href="#TinyPNG" class="headerlink" title="TinyPNG"></a>TinyPNG</h3><div align="center"><img src="../../../../loading2.svg" data-original="/2024/04/27/picture-compress-api/6.jpeg"></div><p>在官网的介绍中，他们这么写：TinyPNG 使用智能有损压缩技术将您的 <code>WebP</code>, <code>PNG</code> 和 <code>JPEG</code> 图片的文件大小降低。 通过选择性的减少图片中的颜色，只需要很少的字节数就能保存数据。 对视觉的影响几乎不可见，但是在文件大小上有非常大的差别。</p><p>经过实测，无论是什么环境下，他们的图片损失都很小，但是压缩率非常高。</p><p><a target="_blank" rel="noopener" href="https://tinypng.com/">https://tinypng.com/</a> 进入之后直接上传即可，每次最多上传 20 张图片。一般来说足够支持需要顺手支持的场景。</p><h3 id="黑魔法"><a href="#黑魔法" class="headerlink" title="黑魔法"></a>黑魔法</h3><p>偶然在知乎上看到了无限制使用 node 压缩图片的解法，先上 Github 地址：（这个并不是我写的，特此注明下）</p><p><a target="_blank" rel="noopener" href="https://github.com/zhanyuzhang/super-tinypng">super-tinypng</a></p><p>知乎原文链接：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/152317953">https://zhuanlan.zhihu.com/p/152317953</a></p><p>这里我概括下作者的思路（大部分为作者原文，这里稍微提炼了下）：</p><blockquote><p>网页版的服务，我们仍然可以达到「无限使用」的效果——事实上我们完全不需要在云端保存那 20 张图片，这在不登录的情况下，是一定存在漏洞的。因此我们可以直接尝试使用网页和服务器的接口实现图片的压缩。<br>一般来说，这种免登录就可试用的系统，都是通过用户 IP 来限制用户的操作次数的。目前的 web 架构大多数都是通过 <code>nginx</code> 作为反向代理的，换句话说，客户端并不是直接请求应用服务的，而是通过统一接入层（往往是 <code>nginx</code>） 来转发请求的。而 <code>nginx</code> 恰恰约定了 <code>X-Forwarded-For</code> 请求头告知下游服务用户的 IP。实际上，基本上所有的反向代理服务都实现了这个约定，以确保下游的服务可以感知到经过的反向代理，并从中获取到用户的 IP 地址。<br>那么我们能不能在客户端伪造这个头部，每次上传图片的时候都设置一个随机的 IP 呢？所以就决定尝试一下。结果发现，该方法确实可行！</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">hostname</span><span class="token operator">:</span> <span class="token string">'TinyPNG – Compress PNG images while preserving transparency'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/web/shrink'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">rejectUnauthorized</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token string-property property">'Postman-Token'</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string-property property">'Cache-Control'</span><span class="token operator">:</span> <span class="token string">'no-cache'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'User-Agent'</span><span class="token operator">:</span>
      <span class="token string">'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36'</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 上传图片的时候加上这两行：</span>
options<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'X-Forwarded-For'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getRandomIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fileUpload</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// console.log('可以压缩：' + file);</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>完整的代码原作者已经在知乎、Github 上开源了，感兴趣的可以自行尝试。</p><p>同时，作者也发布到了 npm 上面。只需要全局安装：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">pnpm</span> i super-tinypng <span class="token parameter variable">-g</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后在你想要压缩图片的目录里面运行 <code>super-tinypng</code> 就能自动压缩图片了，并且不会有数量限制！</p><p>不过 TinyPNG 在未来是完全有可能将这个办法给封杀的，大家能用就早用早享受。</p><h3 id="不受限制的站点"><a href="#不受限制的站点" class="headerlink" title="不受限制的站点"></a>不受限制的站点</h3><p>Free TinyPNG <a target="_blank" rel="noopener" href="https://free.tinypng.site/">https://free.tinypng.site/</a></p><p>这个网站和 TinyPNG 网站几乎一样，不同的是它取消了数量限制，和大小限制。图片超过 5MB，是不能被免费 TinyPNG 的网站服务和 API 接受的。但是在这个站点就可以。</p><p>这个网站有宣称自己的算法和 TinyPNG 一致，不过具体有待考证。</p><h3 id="API-服务"><a href="#API-服务" class="headerlink" title="API 服务"></a>API 服务</h3><p>他们家的 API 服务同样也十分慷慨，对每个账户每个月有 500 次的免费调用次数。更惊喜的是，他们对于主流的代码环境都支持。比如针对于 <code>node.js</code> 他们专门开发了易用的 SDK，实际在最简单的环境中，我们仅需4行代码就可以使用 API 进行图片压缩了。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// npm install tinify</span>
<span class="token keyword">const</span> tinify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"tinify"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
tinify<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token string">"API_KEY"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> source <span class="token operator">=</span> tinify<span class="token punctuation">.</span><span class="token function">fromFile</span><span class="token punctuation">(</span>imagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> source<span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>要获取 API_KEY，只需要注册一个账号，然后就能在官网的控制台中获取。</p><div align="center"><img src="../../../../loading2.svg" data-original="/2024/04/27/picture-compress-api/2.jpeg"></div><p>我们可以在控制台看到我们这个月使用的次数。</p><div align="center"><img src="../../../../loading2.svg" data-original="/2024/04/27/picture-compress-api/1.png"></div><p>如果说想批量压缩图片，这里有个 demo 供参考使用，可以直接在 node 环境下运行。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> tinify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"tinify"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
tinify<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token string">"API_KEY"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> folderPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'OLD_FOLDER_NAME'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 替换为您在外面一级的文件夹路径</span>
<span class="token keyword">const</span> folderName <span class="token operator">=</span> <span class="token string">'NEW_FOLDER_NAME'</span><span class="token punctuation">;</span> <span class="token comment">// 新文件夹的名称，会在当前目录生成</span>
<span class="token keyword">const</span> imageCount <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span> <span class="token comment">// 替换为要压缩的图片数量</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">compressImage</span><span class="token punctuation">(</span><span class="token parameter">imagePath<span class="token punctuation">,</span> outputPath</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> source <span class="token operator">=</span> tinify<span class="token punctuation">.</span><span class="token function">fromFile</span><span class="token punctuation">(</span>imagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> source<span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">压缩成功：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>outputPath<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">压缩失败：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>imagePath<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">compressImagesInFolder</span><span class="token punctuation">(</span><span class="token parameter">folderPath<span class="token punctuation">,</span> count</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> imageFiles <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>folderPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> extension <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> extension <span class="token operator">===</span> <span class="token string">'.png'</span> <span class="token operator">||</span> extension <span class="token operator">===</span> <span class="token string">'.jpg'</span> <span class="token operator">||</span> extension <span class="token operator">===</span> <span class="token string">'.jpeg'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> selectedImages <span class="token operator">=</span> imageFiles<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> imageFile <span class="token keyword">of</span> selectedImages<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> imagePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>folderPath<span class="token punctuation">,</span> imageFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> compressedImagePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> folderName<span class="token punctuation">,</span> imageFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 修改输出路径</span>
      <span class="token keyword">await</span> <span class="token function">compressImage</span><span class="token punctuation">(</span>imagePath<span class="token punctuation">,</span> compressedImagePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 传递输出路径给compressImage函数</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'压缩图片时发生错误：'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">createOutputFolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> folderPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> folderName<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>folderPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>folderPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> folderPath<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token function">createOutputFolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">compressImagesInFolder</span><span class="token punctuation">(</span>folderPath<span class="token punctuation">,</span> imageCount<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>图片压缩的不同姿势，希望能帮助到仔细看完这篇文章的你。</p><p>如果让我说一个总结，我认为在当下（2024.4）我使用这些方法的频率是这样的：</p><ol><li>如果是在不改变当前图片格式的情况下，我会优先使用 tinypng 进行压缩。毕竟我们有办法无限白嫖它。</li><li>如果是在项目中使用，那么 imagemin 是我们优先的考量。能集成在 CI&#x2F;CD 自然是开发的最佳实践之一。</li><li>如果是针对于博客项目，或者一些图片服务，imagemin 有可能不支持对应的脚手架，那么就会使用命令行。这种时候我会统一将图片转成 webp，这样子用户的体验是最好的。</li><li>如果是针对于图片需要小幅修改的场景，那么依据需要修改好的范围，我会针对性的使用 Luna Paint 等集成在 VS Code 中的插件服务 &gt; 能云存储的在线服务 &gt; 到 Photoshop 等图片修改工具进行修改。</li><li>除去以上情形无法解决，我会使用本文提到的部分在线服务。</li></ol><h2 id="参考文档-感谢："><a href="#参考文档-感谢：" class="headerlink" title="参考文档 &amp; 感谢："></a>参考文档 &amp; 感谢：</h2><p><a target="_blank" rel="noopener" href="https://web.dev/articles/codelab-imagemin-webpack?hl=zh-cn">https://web.dev/articles/codelab-imagemin-webpack?hl=zh-cn</a></p></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者: </i></span><span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">海星来来</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接: </i></span><span class="reprint-info"><a href="https://blog.pengdonglai.com/2024/04/27/picture-compress-api/">https://blog.pengdonglai.com/2024/04/27/picture-compress-api/</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明: </i></span><span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh-hans" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">海星来来</a> !</span></div></div><script async defer>document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/API/"><span class="chip bg-color">API</span> </a><a href="/tags/web/"><span class="chip bg-color">web</span> </a><a href="/tags/%E5%9B%BE%E7%89%87/"><span class="chip bg-color">图片</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/share/js/social-share.min.js"></script></div></div></div></div></div><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i>&nbsp;上一篇</div><div class="card"><a href="/2024/05/01/change-log/"><div class="card-image"><img src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/medias/featureimages/0.webp" class="responsive-img" alt="新博客从出生到迁移的变化记录"> <span class="card-title">新博客从出生到迁移的变化记录</span></div></a><div class="card-content article-content"><div class="summary block-with-text">记录下博客的更新日志</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2024-05-01 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E7%A2%8E%E7%A2%8E%E5%BF%B5/" class="post-category">碎碎念</a></span></div></div><div class="card-action article-tags"><a href="/tags/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"><span class="chip bg-color">碎碎念</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/2024/04/14/anime-pictures/"><div class="card-image"><img src="/medias/featureimages/4.webp" class="responsive-img" alt="国内二次元图片API汇总保存"> <span class="card-title">国内二次元图片API汇总保存</span></div></a><div class="card-content article-content"><div class="summary block-with-text">满足下人族的收集癖欲望OvO</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2024-04-14 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E7%9C%9F%E6%AD%A3%E7%9A%84%E7%94%9F%E4%BA%A7%E5%8A%9B/" class="post-category">真正的生产力</a></span></div></div><div class="card-action article-tags"><a href="/tags/%E4%BA%8C%E6%AC%A1%E5%85%83%E5%9B%BE%E7%89%87/"><span class="chip bg-color">二次元图片</span> </a><a href="/tags/API/"><span class="chip bg-color">API</span></a></div></div></div></div></article></div><script>$("#articleContent").on("copy",function(e){var n,t,o,i;void 0!==window.getSelection&&((""+(n=window.getSelection())).length<Number.parseInt("80")||(t=document.getElementsByTagName("body")[0],(o=document.createElement("div")).style.position="absolute",o.style.left="-99999px",t.appendChild(o),o.appendChild(n.getRangeAt(0).cloneContents()),"PRE"===n.getRangeAt(0).commonAncestorContainer.nodeName&&(o.innerHTML="<pre>"+o.innerHTML+"</pre>"),i=document.location.href,o.innerHTML+='<br />来源: 海祇岛的珊瑚森林<br />文章作者: 海星来来<br />文章链接: <a href="'+i+'">'+i+"</a><br />本文章著作权归作者所有，任何形式的转载都请注明出处。",n.selectAllChildren(o),window.setTimeout(function(){t.removeChild(o)},200)))})</script><script src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/codeBlock/codeBlockFuction.js"></script><script src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/codeBlock/codeLang.js"></script><script src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/codeBlock/codeCopy.js"></script><script src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/codeBlock/codeShrink.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget card"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/tocbot/tocbot.min.js"></script><script>$(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });</script></main><footer class="page-footer bg-color"><div class="container row center-align" style="margin-bottom:0!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2019-2025</span> <span id="year">2019</span> <a href="/about" target="_blank">海星来来</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a> <span id="translate">|&nbsp;繁/简：</span><a id="translateLink" href="javascript:translatePage();">繁</a><br>&nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">162.2k</span>&nbsp;字 <span id="busuanzi_container_site_pv">|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>&nbsp;次 </span><span id="busuanzi_container_site_uv">|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span>&nbsp;人</span><br><br></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/umaru2001" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i> </a><a href="mailto:donglaistarfish@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i> </a><a href="https://www.zhihu.com/people/hao-ba-50-81-68" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/hao-ba-50-81-68" data-position="top" data-delay="50"><i class="fab fa-zhihu1">知</i> </a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script>$(function(){!function(t,s,i){"use strict";$.ajax({url:t,dataType:"xml",success:function(t){var e=$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),n=document.getElementById(s),r=document.getElementById(i);n.addEventListener("input",function(){var f='<ul class="search-result-list">',m=this.value.trim().toLowerCase().split(/[\s\-]+/);r.innerHTML="",this.value.trim().length<=0||(e.forEach(function(t){var n,e,r,s,i,l=!0,a=t.title.trim().toLowerCase(),c=t.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),u=0===(u=t.url).indexOf("/")?t.url:"/"+u,o=-1,h=-1;""!==a&&""!==c&&m.forEach(function(t,e){n=a.indexOf(t),o=c.indexOf(t),n<0&&o<0?l=!1:(o<0&&(o=0),0===e&&(h=o))}),l&&(f+="<li><a href='"+u+"' class='search-result-title'>"+a+"</a>",e=t.content.trim().replace(/<[^>]+>/g,""),0<=h&&(s=h+80,(r=h-20)<0&&(r=0),0===r&&(s=100),s>e.length&&(s=e.length),i=e.substr(r,s),m.forEach(function(t){var e=new RegExp(t,"gi");i=i.replace(e,'<em class="search-keyword">'+t+"</em>")}),f+='<p class="search-result">'+i+"...</p>"),f+="</li>")}),f+="</ul>",r.innerHTML=f)})}})}("/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/materialize/materialize.min.js"></script><script src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/masonry/masonry.pkgd.min.js"></script><script src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/aos/aos.js"></script><script src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/scrollprogress/scrollProgress.min.js"></script><script src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/js/matery.js"></script><script src="/live2d-widget/autoload.js"></script><script src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/others/clicklove.js" async></script><script async src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/others/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/js/tw_cn.js"></script><script>var defaultEncoding=2,translateDelay=0,cookieDomain="https://blog.pengdonglai.com",msgToTraditionalChinese="繁",msgToSimplifiedChinese="简",translateButtonId="translateLink";translateInitilization()</script><script src="https://cdn.jsdelivr.net/gh/umaru2001/umaru2001.github.io/libs/instantpage/instantpage.js" type="module"></script>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 3,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var a=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,d=o();function o(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(t){(a||t)&&(d=o());for(var e,i=0;i<d.length;i++)0<=(e=(e=d[i]).getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,a,n,o=d[i];e=function(){d=d.filter(function(t){return o!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(o)},(t=o).dataset.loaded||(t.hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(a=new Image,n=t.getAttribute("data-original"),a.onload=function(){t.src=n,t.removeAttribute("data-original"),t.setAttribute("data-loaded",!0),e&&e()},a.onerror=function(){t.removeAttribute("data-original"),t.setAttribute("data-loaded",!1),t.src=n},t.src!==n&&(a.src=n)))}()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),r.addEventListener("resize",e),r.addEventListener("orientationchange",e)}(this);</script></body></html>